# Build: \
# docker build \
#   -f frontends/main/Dockerfile.web \
#   --build-arg NEXT_PUBLIC_ORIGIN=http://api.open.odl.local:8062 \
#   --build-arg NEXT_PUBLIC_MITOL_API_BASE_URL=http://open.odl.local:8063 \
#   --build-arg NEXT_PUBLIC_SITE_NAME="MIT Learn" \
#   --build-arg NEXT_PUBLIC_MITOL_SUPPORT_EMAIL=mitlearn-support@mit.edu \
#   --build-arg NEXT_PUBLIC_EMBEDLY_KEY= \
#   --build-arg NEXT_PUBLIC_MITOL_AXIOS_WITH_CREDENTIALS=true \
#   --build-arg NEXT_PUBLIC_CSRF_COOKIE_NAME=csrftoken-local \
#   -t mitodl/mit-learn-frontend:latest .

# Run:
# docker run -p 8062:8062 -e PORT=8062 mit-learn-frontend:latest

# Heroku build/push:
#
# heroku container:push web \
#   --app mitopen-rc-nextjs \
#   --recursive \
#   --arg NEXT_PUBLIC_ORIGIN=https://next.rc.learn.mit.edu, \
#   NEXT_PUBLIC_MITOL_API_BASE_URL=https://api.rc.learn.mit.edu, \
#   NEXT_PUBLIC_SITE_NAME="MIT Learn", \
#   NEXT_PUBLIC_MITOL_SUPPORT_EMAIL=mitlearn-support@mit.edu, \
#   NEXT_PUBLIC_EMBEDLY_KEY=*******, \
#   NEXT_PUBLIC_MITOL_AXIOS_WITH_CREDENTIALS=true, \
#   NEXT_PUBLIC_CSRF_COOKIE_NAME=learn-rc-csrftoken \
#   --context-path .

# Heroku release:
# heroku ps:scale frontend=1 --app mitopen-rc-nextjs
# heroku container:release --app mitopen-rc-nextjs frontend


FROM node:22-alpine

RUN apk update
RUN apk add --no-cache libc6-compat

WORKDIR /app

COPY .yarnrc.yml /app
COPY .yarn/releases /app/.yarn/releases
COPY yarn.lock /app
COPY package.json /app
COPY frontends /app/frontends

RUN yarn install --immutable

WORKDIR /app/frontends/main

# Next.js collects completely anonymous telemetry data about general usage.
# Learn more here: https://nextjs.org/telemetry
# Uncomment the following line in case you want to disable telemetry during the build.
# ENV NEXT_TELEMETRY_DISABLED=1

ENV NODE_ENV=production

ARG NEXT_PUBLIC_ORIGIN
ENV NEXT_PUBLIC_ORIGIN=$NEXT_PUBLIC_ORIGIN

ARG NEXT_PUBLIC_MITOL_API_BASE_URL
ENV NEXT_PUBLIC_MITOL_API_BASE_URL=$NEXT_PUBLIC_MITOL_API_BASE_URL

ARG NEXT_PUBLIC_SITE_NAME
ENV NEXT_PUBLIC_SITE_NAME=$NEXT_PUBLIC_SITE_NAME

ARG NEXT_PUBLIC_MITOL_SUPPORT_EMAIL
ENV NEXT_PUBLIC_MITOL_SUPPORT_EMAIL=$NEXT_PUBLIC_MITOL_SUPPORT_EMAIL

ARG NEXT_PUBLIC_EMBEDLY_KEY=None
ENV NEXT_PUBLIC_EMBEDLY_KEY=$NEXT_PUBLIC_EMBEDLY_KEY

ARG NEXT_PUBLIC_MITOL_AXIOS_WITH_CREDENTIALS=true
ENV NEXT_PUBLIC_MITOL_AXIOS_WITH_CREDENTIALS=$NEXT_PUBLIC_MITOL_AXIOS_WITH_CREDENTIALS

ARG NEXT_PUBLIC_CSRF_COOKIE_NAME
ENV NEXT_PUBLIC_CSRF_COOKIE_NAME=$NEXT_PUBLIC_CSRF_COOKIE_NAME

ARG NEXT_PUBLIC_POSTHOG_API_HOST
ENV NEXT_PUBLIC_POSTHOG_API_HOST=$NEXT_PUBLIC_POSTHOG_API_HOST
ARG NEXT_PUBLIC_POSTHOG_PROJECT_ID
ENV NEXT_PUBLIC_POSTHOG_PROJECT_ID=$NEXT_PUBLIC_POSTHOG_PROJECT_ID
ARG NEXT_PUBLIC_POSTHOG_API_KEY
ENV NEXT_PUBLIC_POSTHOG_API_KEY=$NEXT_PUBLIC_POSTHOG_API_KEY

ARG NEXT_PUBLIC_SENTRY_DSN
ENV NEXT_PUBLIC_SENTRY_DSN=$NEXT_PUBLIC_SENTRY_DSN
ARG NEXT_PUBLIC_SENTRY_ENV
ENV NEXT_PUBLIC_SENTRY_ENV=$NEXT_PUBLIC_SENTRY_ENV
ARG NEXT_PUBLIC_VERSION
ENV NEXT_PUBLIC_VERSION=$NEXT_PUBLIC_VERSION
ARG NEXT_PUBLIC_SENTRY_PROFILES_SAMPLE_RATE
ENV NEXT_PUBLIC_SENTRY_PROFILES_SAMPLE_RATE=$NEXT_PUBLIC_SENTRY_PROFILES_SAMPLE_RATE
ARG NEXT_PUBLIC_SENTRY_TRACES_SAMPLE_RATE
ENV NEXT_PUBLIC_SENTRY_TRACES_SAMPLE_RATE=$NEXT_PUBLIC_SENTRY_TRACES_SAMPLE_RATE

ARG NEXT_PUBLIC_APPZI_URL
ENV NEXT_PUBLIC_APPZI_URL=$NEXT_PUBLIC_APPZI_URL

ENV NEXT_PUBLIC_DEFAULT_SEARCH_MODE="phrase"
ENV NEXT_PUBLIC_DEFAULT_SEARCH_SLOP="6"
ENV NEXT_PUBLIC_DEFAULT_SEARCH_STALENESS_PENALTY="2.5"
ENV NEXT_PUBLIC_DEFAULT_SEARCH_MINIMUM_SCORE_CUTOFF="0"
ENV NEXT_PUBLIC_DEFAULT_SEARCH_MAX_INCOMPLETENESS_PENALTY="90"

RUN yarn build

EXPOSE 3000

ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# CMD ["node", "/app/frontends/main/.next/standalone/frontends/main/server.js"]
CMD ["yarn", "start"]
